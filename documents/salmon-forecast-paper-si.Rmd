---
title: "Improving Forecasts of Sockeye Salmon (*Oncorhynchus nerka*) with Parametric and Non-Parametric Models"
subtitle: Supporting Information
author:
- Daniel Ovando*
- Curry Cunningham
- Peter Kuriyama
- Chris Boatright
- Ray Hilborn
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2: default
  bookdown::word_document2:
    reference_docx: template.docx
  pdf_document: default
bibliography: ../references.bib
csl: canadian-journal-of-fisheries-and-aquatic-sciences.csl
params:
  results_name: v1.1.0
linkcolor: blue
toc: FALSE
header-includes:
- \usepackage{setspace}\doublespacing
- \usepackage{lineno}\linenumbers
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,  dev = "cairo_pdf", message = FALSE, warning = FALSE)
library(tidyverse)
library(patchwork)
library(cowplot)
library(magick)
library(hrbrthemes)
library(ggplot2)
library(Cairo)
library(extrafont)
library(here)
library(scales)
library(knitr)
library(kableExtra)
library(ggridges)
extrafont::loadfonts()

results_dir <- here("results", params$results_name)

pub_theme <-
  hrbrthemes::theme_ipsum(base_size = 10, axis_text_size = 8, axis_title_size = 12) +
  theme(
    panel.spacing = unit(0.5, "lines"),
    plot.margin = unit(rep(10, 4), units = "points")
  )

theme_set(pub_theme)


# load plots

load(file = file.path(results_dir, "plots.RData"))

load(file = file.path(results_dir, "performance.RData"))

load(file = file.path(results_dir, "forecasts.RData"))


```

```{r models}

benchmarks <- system_performance %>% 
  filter(model == "fri" | model == "lag(1)") %>% 
  select(model, system, rmse) %>% 
  pivot_wider(names_from = model, values_from = "rmse")

age_benchmarks <- age_performance %>% 
  filter(model == "fri" | model == "lag(1)") %>% 
  select(model, age_group, rmse) %>% 
  pivot_wider(names_from = model, values_from = "rmse")


sys_performers <- system_performance %>% 
  filter(!model %in% c("fri"), !str_detect(model,"ensemble")) %>% 
  group_by(system) %>% 
  filter(srmse == min(srmse))

comp_sys_improvement <- sys_performers %>% 
  select(model, system, rmse) %>% 
  left_join(benchmarks, by = "system") %>% 
  ungroup() %>% 
  summarise(imp_on_fri = -mean(rmse / fri - 1),
            min_imp_on_fri = min(-(rmse / fri - 1)),
            max_imp_on_fri = max(-(rmse / fri - 1)),
            imp_on_lag =  -mean(rmse / `lag(1)` - 1))

tmp <- sys_performers %>% 
  select(model, system, rmse) %>% 
  left_join(benchmarks, by = "system") %>% 
  ungroup() %>% 
  mutate(imp_on_fri = -(rmse / fri - 1),
            min_imp_on_fri = (-(rmse / fri - 1)),
            max_imp_on_fri = (-(rmse / fri - 1)),
            imp_on_lag =  -(rmse / `lag(1)` - 1))

age_performers <- age_performance %>% 
  filter(!model %in% c("fri", "boost_tree_ensemble")) %>% 
  group_by(age_group) %>% 
  filter(srmse == min(srmse))

tmp2 <- age_performers %>% 
  select(model, age_group, rmse) %>% 
  left_join(age_benchmarks, by = "age_group") %>% 
  ungroup() %>% 
  mutate(imp_on_fri = -(rmse / fri - 1),
            min_imp_on_fri = (-(rmse / fri - 1)),
            max_imp_on_fri = (-(rmse / fri - 1)),
            imp_on_lag =  -(rmse / `lag(1)` - 1))

a = tmp %>%
  ggplot(aes(reorder(system, -imp_on_fri), imp_on_fri, fill = model)) +
  geom_hline(aes(yintercept = 0)) +
  geom_col(color = "black") +
  scale_y_percent(name = "% Improvement on Traditional FRI Methods") +
  scale_x_discrete(name = '')+
  fishualize::scale_fill_fish_d(name = 'Best Model', option = "Trimma_lantana") + 
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 14)) 

ggsave( "rep_fig_1.pdf",a, device = cairo_pdf, width = 6, height = 4)

b = tmp2 %>%
  mutate(age_group = str_replace_all(age_group,"_",".")) %>% 
  ggplot(aes(reorder(age_group, -imp_on_fri), imp_on_fri, fill = model)) +
  geom_hline(aes(yintercept = 0)) +
  geom_col(color = "black") +
  scale_y_percent(name = "% Improvement on Traditional FRI Methods") +
  scale_x_discrete(name = '')+
  fishualize::scale_fill_fish_d(name = 'Best Model', option = "Trimma_lantana") + 
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 14)) 

ggsave( "rep_fig_2.pdf",b, device = cairo_pdf, width = 6, height = 4)



d <- total_forecast %>%
  filter(model %in% c("boost_tree", "fri")) %>%
  group_by(year) %>%
  mutate(observed = mean(observed)) %>%
  pivot_wider(names_from = "model", values_from = "forecast") %>%
  ggplot() +
  geom_hline(aes(yintercept = 0)) +
  geom_area(aes(year, observed),fill = "lightgrey") +
  geom_point(aes(year, boost_tree, fill = "boost_tree"), shape = 21, size = 4,alpha = 0.9) +
  geom_point(aes(year, fri, fill = "UW-FRI"), shape = 21, size = 4,alpha =0.9) + 
  fishualize::scale_fill_fish_d(name = '', option = "Trimma_lantana") + 
  scale_y_continuous(name = "Total Returns") + 
  scale_x_continuous(name = 'Year') + 
    theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 14)) 


ggsave( "rep_fig_3.pdf",d, device = cairo_pdf, width = 6, height = 4)

fri_system_mape <- system_forecast %>% 
  filter(model == "fri") %>%
  group_by(model) %>% 
  summarise(mape = yardstick::mape_vec(observed, forecast))

fri_age_mape <- age_forecast %>% 
  filter(model == "fri") %>%
  group_by(model, age_group) %>% 
  summarise(mape = yardstick::mape_vec(observed, forecast))

# system_forecast %>% 
#   ggplot(aes(observed, forecast)) + 
#   geom_point() + 
#   geom_abline(aes(slope = 1, intercept = 0)) +
#   facet_wrap(~model)


mean_srmse_delta <- system_performance %>% 
    filter(!model %in% c("fri", "boost_tree_ensemble")) %>% 
  group_by(system) %>% 
  mutate(rmse_rank = rank(rmse)) %>% 
  filter(rmse_rank <= 2) %>% 
  arrange(system) %>% 
  group_by(system) %>% 
  summarise(delta  = srmse[rmse_rank == 2] - srmse[rmse_rank == 1]) %>% 
  ungroup() %>% 
  summarise(mmd = mean(delta))

comp_sys_improvement <- sys_performers %>% 
  select(model, system, rmse) %>% 
  left_join(benchmarks, by = "system") %>% 
  ungroup() %>% 
  summarise(imp_on_fri = -mean(rmse / fri - 1),
            min_imp_on_fri = min(-(rmse / fri - 1)),
            max_imp_on_fri = max(-(rmse / fri - 1)),
            imp_on_lag =  -mean(rmse / `lag(1)` - 1))


sys_improv <- system_performance %>% 
  select(model, system, srmse) %>% 
  pivot_wider(names_from = model, values_from = srmse) %>% 
  pivot_longer(-c(system, fri), names_to = "model", values_to = "srmse") %>% 
  group_by(system) %>% 
  filter(srmse == min(srmse)) %>% 
  ungroup() %>% 
  summarise(srmse_improv = mean((srmse - fri) / fri))

age_improv <- age_performance %>% 
  select(model, age_group, srmse) %>% 
  pivot_wider(names_from = model, values_from = srmse) %>% 
  pivot_longer(-c(age_group, fri), names_to = "model", values_to = "srmse") %>% 
  group_by(age_group) %>% 
  filter(srmse == min(srmse)) %>% 
  ungroup() %>% 
  summarise(srmse_improv = mean((srmse - fri) / fri))


```


\renewcommand{\thefigure}{S\arabic{figure}}

\setcounter{figure}{0}

\renewcommand{\thetable}{S\arabic{table}}

\setcounter{table}{0}

```{r srmse-fig, fig.cap="Scaled root mean squared error (SRMSE) for each model type (rows) by age group and system (columns). rand_forest refers to a random forest, fri to the Fisheries Research Institute historic forecast, edm to empirical dynamic modeling, dlm to dynamic linear model, boost_tree to boosted regression tree.", fig.height=6}
srmse_summary_figure + 
  theme(axis.text.x = element_text(size = 6))
```

\newpage

```{r bias-fig, fig.cap="Mean bias (forecast - observed) in millions of fish by model, age group, and river system. rand_forest refers to a random forest, fri to the Fisheries Research Institute historic forecast, edm to empirical dynamic modeling, dlm to dynamic linear model, boost_tree to boosted regression tree.", fig.height=6}
mpe_summary_figure + 
  theme(axis.text.x = element_text(size = 6), legend.position = "top")
```

```{r srmse-fig-two, fig.cap="Best performing model in terms of scaled root mean squared error (SRMSE) for each age group and river system. Color indicates the percent improvement in SRMSE between the best performing model and the historic published Fisheries Research Institute (FRI) forecasts. rand_forest refers to a random forest, fri to the Fisheries Research Institute historic forecast, edm to empirical dynamic modeling, dlm to dynamic linear model, boost_tree to boosted regression tree."}
age_system_performance_figure
```


```{r btreefig, fig.cap="Observed and boosted regression tree forecasts of sockeye salmon returns by river system (columns) an age group (rows). Values in each panel are max scaled to demonstrate general correlation between observed and forecasted values."}
age_system_forecast %>% 
  filter(model == "boost_tree") %>% 
  group_by(system, age_group) %>% 
  mutate(observed = observed / max(observed),
         forecast = forecast / max(forecast)) %>% 
  ggplot(aes(observed, forecast, color = year)) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE, color= "red", size = 1) +
  facet_grid(age_group~system, scales = "free")  + 
  theme(legend.position = "top") + 
  scale_color_viridis_c(name= 'Year') + 
  scale_x_continuous(breaks = c(0,1), labels = c("Min","Max"))+
  scale_y_continuous(breaks = c(0,1), labels = c("Min","Max"))+
  labs(x = "Observed", y = "Forecast", title = "Boosted regression tree")
```




```{r rffig, fig.cap="Observed and random forest forecasts of sockeye salmon returns by river system (columns) an age group (rows). Values in each panel are max scaled to demonstrate general correlation between observed and forecasted values."}
age_system_forecast %>% 
  filter(model == "rand_forest") %>% 
  group_by(system, age_group) %>% 
  mutate(observed = observed / max(observed),
         forecast = forecast / max(forecast)) %>% 
  ggplot(aes(observed, forecast, color = year)) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE, color= "red", size = 1) +
  facet_grid(age_group~system, scales = "free")  + 
  theme(legend.position = "top") + 
  scale_color_viridis_c(name= 'Year') + 
  scale_x_continuous(breaks = c(0,1), labels = c("Min","Max"))+
  scale_y_continuous(breaks = c(0,1), labels = c("Min","Max"))+
  labs(x = "Observed", y = "Forecast", title = "Random forest")
```


```{r dlmfig, fig.cap="Observed and dynamic linear model forecasts of sockeye salmon returns by river system (columns) an age group (rows). Values in each panel are max scaled to demonstrate general correlation between observed and forecasted values."}
age_system_forecast %>% 
  filter(model == "dlm") %>% 
  group_by(system, age_group) %>% 
  mutate(observed = observed / max(observed),
         forecast = forecast / max(forecast)) %>% 
  ggplot(aes(observed, forecast, color = year)) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE, color= "red", size = 1) +
  facet_grid(age_group~system, scales = "free")  + 
  theme(legend.position = "top") + 
  scale_color_viridis_c(name= 'Year') + 
  scale_x_continuous(breaks = c(0,1), labels = c("Min","Max"))+
  scale_y_continuous(breaks = c(0,1), labels = c("Min","Max"))+
  labs(x = "Observed", y = "Forecast", title = "Dynamic linear model")
```


```{r edmfig, fig.cap="Observed and empirical dynamic model forecasts of sockeye salmon returns by river system (columns) an age group (rows). Values in each panel are max scaled to demonstrate general correlation between observed and forecasted values."}
age_system_forecast %>% 
  filter(model == "edm") %>% 
  group_by(system, age_group) %>% 
  mutate(observed = observed / max(observed),
         forecast = forecast / max(forecast)) %>% 
  ggplot(aes(observed, forecast, color = year)) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE, color= "red", size = 1) +
  facet_grid(age_group~system, scales = "free")  + 
  theme(legend.position = "top") + 
  scale_color_viridis_c(name= 'Year') + 
  scale_x_continuous(breaks = c(0,1), labels = c("Min","Max"))+
  scale_y_continuous(breaks = c(0,1), labels = c("Min","Max"))+
  labs(x = "Observed", y = "Forecast", title = "Empirical dynamic model")
```


```{r lagfig, fig.cap="Observed and lag(1) forecast of sockeye salmon returns by river system (columns) an age group (rows). Values in each panel are max scaled to demonstrate general correlation between observed and forecasted values."}
age_system_forecast %>% 
  filter(model == "lag(1)") %>% 
  group_by(system, age_group) %>% 
  mutate(observed = observed / max(observed),
         forecast = forecast / max(forecast)) %>% 
  ggplot(aes(observed, forecast, color = year)) + 
  geom_abline(intercept = 0, slope = 1, linetype = 2) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE, color= "red", size = 1) +
  facet_grid(age_group~system, scales = "free")  + 
  theme(legend.position = "top") + 
  scale_color_viridis_c(name= 'Year') + 
  scale_x_continuous(breaks = c(0,1), labels = c("Min","Max"))+
  scale_y_continuous(breaks = c(0,1), labels = c("Min","Max"))+
  labs(x = "Observed", y = "Forecast", title = "Lag(1)")
```

\newpage


```{r retfig, fig.cap="Trends in returns of sockeye salmon to Bristol Bay river systems (columns) over time (x-axis) by age group (rows)"}
age_system_forecast %>% 
    filter(model == "lag(1)") %>% 
  group_by(age_group, system) %>% 
  mutate(ret = observed / max(observed)) %>% 
  ggplot(aes(year, ret)) + 
  geom_line() +
  facet_grid(age_group ~ system, scales = "free_y") + 
  theme_minimal_grid() +
  scale_x_continuous(guide = guide_axis(n.dodge = 2), name = "Returns") +
  scale_y_continuous(breaks = c(0,1), labels = c("Min","Max"), name = 'Year') +
  theme(axis.text.x = element_text(size = 6))
```

\newpage

```{r pearson, fig.cap="Distribution of Pearson's residuals by model type for forecasts at the resolution of returns by age group and river system by year"}

pearson_residuals <- age_system_forecast %>% 
  group_by(model) %>% 
  mutate(pearson_residual = (forecast - observed) / sd(forecast))
  

pearson_residuals_model <- pearson_residuals %>% 
  mutate(model = fct_relevel(model,"lag(1)"),
         pearson_residual = pmax(-2.5,pmin(pearson_residual,2.5))) %>% 
  filter(model != "fri")

pearson_residuals <- age_system_forecast %>% 
  group_by(model) %>% 
  mutate(pearson_residual = (forecast - observed) / sd(forecast))
  

# pearson_residuals_model %>% 
#   group_by(model) %>% 
#   summarise(cv = sd(pearson_residual),
#             mean = mean(pearson_residual))

pearson_residuals_model %>% 
  ggplot(aes(x = pearson_residual, y = model)) + 
  geom_vline(aes(xintercept = 0), linetype = 2) +
  geom_density_ridges(aes(fill = model),show.legend = FALSE,alpha = 0.9) + 
  scale_x_continuous(name = "Pearson's residsuals") + 
  scale_y_discrete(name = '')



```


\newpage




```{r abspearson, fig.cap="Difference in absolute Pearson residuals across model types (mean and 95% confidence intervals) relative to the lag(1) model. Results indicate no significant (p<0.05) differences in the absolute values of the pearson residuals across model types."}

pearson_residuals <- pearson_residuals %>% 
  mutate(abs_pearson_residual = abs(pearson_residual)) %>% 
   mutate(model = fct_relevel(model,"lag(1)")) %>% 
   filter(model != "fri")

abs_pearson_resid_model <- lm(abs_pearson_residual ~ model, data = pearson_residuals)

foo <- function(x){
  str_remove_all(x, "model")
}

modelsummary::modelplot(abs_pearson_resid_model, coef_rename = foo) + 
  scale_y_discrete(name = "Model")

```


\newpage


```{r edmfun, fig.cap="Within-sample prediction (measured as correlation coefficient between observations and predictions) from data up to 2000. The largest increase in correlation is seen in Nushagak, where the coefficients with embedding dimensions (E)=4 are about 0.25 greater than the coefficients with E=2. However, the out-of-sample forecast skill for Nushagak was lower with E=4 than with E=2. We feel E=2 is a parsimonious approach that results in simpler, lower dimensional models applied to all systems.", out.width="75%", fig.align="center"}
knitr::include_graphics(here("documents","images", "embedding.png"))
```


\newpage

+-----------------------------------+-----------------------------------------------------------------------------------------------+-------------------------------------------------------+
| Data Type                         | Description                                                                                   | Dataset ID                                            |
+===================================+===============================================================================================+=======================================================+
| Sea Surface Temperature           | HadISST Average Sea Surface Temperature, 1Â°, Global, Monthly, 1870-present                    | erdHadISST                                            |
+-----------------------------------+-----------------------------------------------------------------------------------------------+-------------------------------------------------------+
| Sea Level Pressure                | Sea Level Pressure Monthly Mean at Surface, ICOADS, 1-degree, Enhanced, Monthly, 1960-present | esrlIcoads1ge                                         |
+-----------------------------------+-----------------------------------------------------------------------------------------------+-------------------------------------------------------+
| Upwelling                         | u-wind Stress Monthly Mean at Surface, ICOADS, 1-degree, Enhanced, Monthly, 1960-present      | esrlIcoads1ge                                         |
+-----------------------------------+-----------------------------------------------------------------------------------------------+-------------------------------------------------------+
|                                   |                                                                                               |                                                       |
+-----------------------------------+-----------------------------------------------------------------------------------------------+-------------------------------------------------------+
| Pacific Decadal Oscillation Index | PDO Index                                                                                     | <http://research.jisao.washington.edu/pdo/PDO.latest> |
+-----------------------------------+-----------------------------------------------------------------------------------------------+-------------------------------------------------------+

: (\#tab:env-data) Environmental Covariates Evaluated

+----------------------------------------+-------------------------------------------------------------------------------+
| Model Name                             | Description                                                                   |
+========================================+===============================================================================+
| Boosted Regression Trees (boost\_tree) | An ensemble of boosted regression trees                                       |
+----------------------------------------+-------------------------------------------------------------------------------+
| Random Forest (rand\_forest)           | An ensemble of regression trees                                               |
+----------------------------------------+-------------------------------------------------------------------------------+
| Dynamic Linear Model (dlm)             | Sibling regression with dynamic components                                    |
+----------------------------------------+-------------------------------------------------------------------------------+
| Empirical Dynamic Modeling  (multiview)| Simplex projection based on lagged values                                     |
+----------------------------------------+-------------------------------------------------------------------------------+
| Lag(1)                                 | Forecast next year equal to observed returns last year                        |
+----------------------------------------+-------------------------------------------------------------------------------+
| Ensemble                               | A random forest ensemble made of other candidate models                       |
+----------------------------------------+-------------------------------------------------------------------------------+
|                                        |                                                                               |
+----------------------------------------+-------------------------------------------------------------------------------+

: (\#tab:models) Candidate forecasting models evaluated



\newpage


```{r tuning-table, results="asis"}


boost_tree_grid <-
  tribble(
    ~ "Variable",
    ~ "Abbreviation",
    ~ "Range Tested",
    "Minimum node size",
    "min_n",
    "[2,10]",
    "Maximum tree depth",
    "tree_depth",
    "[2,15]",
    "Learning rate",
    "learn_rate",
    "[0.05,0.6]",
    "Number of randomly sampled predictors",
    "mtry",
    "[1,# of Predictors]",
    "Loss reduction for further splitting",
    "loss_reduction",
    "[1e-15,2]",
    "Number of trees",
    "trees",
    "[500,2000]"
  ) %>% 
  mutate(model = "Boosted Regression Tree (xgboost)")



rf_grid <-
  tribble(
    ~ "Variable",
    ~ "Abbreviation",
    ~ "Range Tested",
    "Minimum node size",
    "min_n",
    "[2,10]",
    "Number of randomly sampled predictors",
    "mtry",
    "[1,# of Predictors]",
    "Number of trees",
    "trees",
    "[500,2000]"
  ) %>% 
  mutate(model = "Random forest (ranger)")

grid_summary <- boost_tree_grid %>% 
  bind_rows(rf_grid)


kbl(grid_summary, caption = "Ranges of tuning parameters tested for machine learning models", booktabs = TRUE)



```

